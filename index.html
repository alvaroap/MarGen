<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>GDP - V 8.1.3 Icono Limpio</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-app: #F2F2F2;
            --bg-shell: #E5E7EB;
            --header-dark: #3d3d3d;
            --text-main: #1e293b;
            --text-muted: #475569; 
            --white: #ffffff;
            --radius-card: 2rem; 
        }

        body { font-family: "Benton Sans", "Inter", sans-serif; -webkit-font-smoothing: antialiased; background-color: var(--bg-shell); margin: 0; font-size: 16px; overflow-x: hidden; }
        .app-shell { max-width: 448px; margin: 0 auto; background: var(--bg-app); min-height: 100vh; position: relative; display: flex; flex-direction: column; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        
        /* TRANSICIONES 0.5s */
        @keyframes viewFadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .view-transition { animation: viewFadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes modalSlideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes overlayFade { from { opacity: 0; } to { opacity: 1; } }
        .modal-overlay-bg { animation: overlayFade 0.4s ease-out forwards; }
        .modal-animate-content { animation: modalSlideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        .v-progress-liquid { height: 100%; transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }

        /* BIENVENIDA */
        .welcome-screen { position: absolute; inset: 0; background: #000; color: #fff; z-index: 200; display: flex; flex-direction: column; padding: 4rem 2.5rem; justify-content: space-between; }
        .visual-hero { position: relative; height: 180px; margin-top: 1rem; }
        .hero-icon { position: absolute; width: 56px; height: 56px; border-radius: 1.25rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        .hi-1 { background: #06b6d4; left: 0; top: 40px; transform: rotate(-10deg); z-index: 5; }
        .hi-2 { background: #f43f5e; left: 40px; top: 10px; transform: rotate(5deg); z-index: 4; }
        .hi-3 { background: #d946ef; left: 90px; top: 50px; transform: rotate(15deg); z-index: 3; }
        .hi-4 { background: #f472b6; left: 135px; top: 15px; transform: rotate(-5deg); z-index: 2; }
        .hi-5 { background: #ef4444; left: 185px; top: 45px; transform: rotate(10deg); z-index: 1; opacity: 0.9; }

        .welcome-title { font-size: 3.25rem; font-weight: 900; line-height: 0.95; letter-spacing: -2px; margin-bottom: 1.5rem; }
        .welcome-msg { color: #94a3b8; font-size: 1.15rem; line-height: 1.5; font-weight: 400; margin-bottom: 2rem; }
        .btn-welcome { background: #22c55e; color: #fff; width: 100%; height: 80px; border-radius: 2rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em; font-size: 0.85rem; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* HEADER */
        .header-home { background: var(--white); padding: 1.5rem; margin-bottom: 2rem; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; border-radius: 0 0 1.5rem 1.5rem; position: relative; }
        .year-selector { grid-column: 2; font-weight: 900; color: var(--text-main); font-size: 1.875rem; }
        .btn-export { grid-column: 3; justify-self: end; background: #f8fafc; color: var(--text-muted); width: 2.75rem; height: 2.75rem; border-radius: 1rem; display: flex; align-items: center; justify-content: center; border: 1px solid #f1f5f9; cursor: pointer; transition: all 0.2s; }
        .btn-export.success { background: #22c55e; color: white; border-color: #22c55e; }
        
        .header-dark-strip { background-color: var(--header-dark); padding: 1.5rem; color: var(--white); border-radius: 0 0 2.5rem 2.5rem; margin-bottom: 1.5rem; text-align: left; }
        .main-content { padding: 0 1.5rem 8rem 1.5rem; }
        .card-presupuesto { background: var(--white); border-radius: var(--radius-card); padding: 1.5rem; display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; transition: transform 0.2s; }
        .card-presupuesto:active { transform: scale(0.98); }
        .texto-titulo { font-size: 1.5rem; font-weight: 900; color: var(--text-main); line-height: 1; margin-bottom: 0.5rem; }
        .texto-info-secundaria { display: flex; align-items: center; gap: 0.5rem; font-size: 1rem; font-weight: 700; color: var(--text-muted); }
        .glass-footer { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 448px; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); border-top: 1px solid rgba(0,0,0,0.1); padding: 1.25rem 0; border-radius: 2rem 2rem 0 0; z-index: 40; display: flex; flex-direction: column; align-items: center; }
        .circle-plus { background: #000; color: #fff; width: 3.5rem; height: 3.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; margin-bottom: 0.25rem; border: none; }
        
        .gasto-header-title { font-size: 1rem; color: #444; font-weight: 700; margin-bottom: 0.25rem; padding-left: 0.25rem; text-align: left; }
        .gasto-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem; padding: 0 0.25rem; margin-bottom: 2rem; }
        .gasto-icon-btn { aspect-ratio: 1; border-radius: 1rem; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; color: white; transition: all 0.2s; }
        .gasto-icon-btn.selected { transform: scale(1.1); box-shadow: 0 0 0 3px #000; }
        .btn-close-modal { position: absolute; top: 2rem; right: 2rem; background: #f3f4f6; width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-muted); border: none; z-index: 50; }
        .calc-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; width: 100%; }
        .calc-btn { padding: 1.25rem 0; border-radius: 1.25rem; font-size: 1.5rem; font-weight: 700; background: #f9fafb; border: none; color: var(--text-main); }
        .barra-progreso-bg { width: 100%; height: 1rem; background: #f1f5f9; border-radius: 99px; overflow: hidden; }
        .icono-presupuesto { width: 3.5rem; height: 3.5rem; border-radius: 1rem; display: flex; align-items: center; justify-content: center; color: var(--white); }
        .btn-edit-universal { color: var(--text-muted); padding: 0.5rem; display: flex; align-items: center; justify-content: center; background: transparent; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, memo, useRef } = React;

        const CATALOGO_PRESUPUESTOS = [
            { id: 'home', label: 'Vivienda', color: 'bg-blue-500' },
            { id: 'car-front', label: 'Coche', color: 'bg-slate-600' },
            { id: 'plane', label: 'Viajes', color: 'bg-cyan-500' },
            { id: 'utensils', label: 'Restaurante', color: 'bg-orange-400' },
            { id: 'baby', label: 'Hijos', color: 'bg-pink-400' },
            { id: 'graduation-cap', label: 'Estudios', color: 'bg-indigo-600' },
            { id: 'shopping-bag', label: 'Compras', color: 'bg-rose-500' },
            { id: 'shopping-cart', label: 'Super', color: 'bg-green-500' },
            { id: 'piggy-bank', label: 'Ahorro', color: 'bg-emerald-600' },
            { id: 'hand-coins', label: 'Ingresos', color: 'bg-teal-500' },
            { id: 'heart-pulse', label: 'Salud', color: 'bg-red-500' },
            { id: 'dog', label: 'Mascotas', color: 'bg-amber-700' },
            { id: 'smile', label: 'Ocio', color: 'bg-fuchsia-500' },
            { id: 'dumbbell', label: 'Deporte', color: 'bg-lime-600' },
            { id: 'laptop', label: 'Tecno', color: 'bg-slate-800' },
            { id: 'gift', label: 'Regalos', color: 'bg-red-400' },
            { id: 'zap', label: 'Facturas', color: 'bg-yellow-500' },
            { id: 'shield-check', label: 'Seguros', color: 'bg-sky-600' },
            { id: 'hammer', label: 'Reformas', color: 'bg-orange-800' },
            { id: 'globe', label: 'Misc', color: 'bg-slate-400' }
        ];

        const BIBLIOTECA_GASTOS = [
            { cat: 'Vivienda', color: 'bg-blue-500', icons: ['home', 'hammer', 'lamp', 'tree-pine', 'key-round'] },
            { cat: 'Transporte', color: 'bg-slate-600', icons: ['car', 'fuel', 'train-front', 'parking-circle', 'wrench'] },
            { cat: 'Viajes', color: 'bg-cyan-500', icons: ['plane', 'map', 'hotel', 'palmtree', 'luggage'] },
            { cat: 'Restaurante', color: 'bg-orange-400', icons: ['utensils-crossed', 'coffee', 'pizza', 'sandwich', 'ice-cream'] },
            { cat: 'Hijos', color: 'bg-pink-400', icons: ['baby', 'toy-brick', 'milk', 'book-open', 'milestone'] },
            { cat: 'Compras', color: 'bg-rose-500', icons: ['shopping-bag', 'shirt', 'footprints', 'watch', 'gem'] },
            { cat: 'Super', color: 'bg-green-500', icons: ['shopping-cart', 'apple', 'croissant', 'cup-soda', 'sparkles'] },
            { cat: 'Salud', color: 'bg-red-500', icons: ['pill', 'stethoscope', 'thermometer', 'activity', 'brain'] },
            { cat: 'Misc', color: 'bg-slate-400', icons: ['globe', 'package', 'archive', 'more-horizontal', 'help-circle'] }
        ];

        const hardFmt = (val) => {
            if (val === undefined || val === null) return '0 €';
            let n = parseInt(val.toString().replace(/\./g, '')) || 0;
            return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + ' €';
        };

        const prettyDate = (iso) => {
            if(!iso) return "";
            const [y, m, d] = iso.split("-");
            const months = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
            return `${parseInt(d)} ${months[parseInt(m)-1]} ${y}`;
        };

        const Calculator = memo(({ initialValue = '0', onNext }) => {
            const [val, setVal] = useState(initialValue.toString().replace(/\./g, ''));
            const press = (n) => setVal(prev => prev === '0' ? String(n) : (prev.length > 8 ? prev : prev + n));
            const back = () => setVal(prev => prev.length <= 1 ? '0' : prev.slice(0, -1));
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });
            return (
                <div className="text-center">
                    <p className="text-[0.625rem] font-black uppercase text-slate-400 mb-5 text-center tracking-widest">Importe</p>
                    <div className="flex items-center justify-center gap-1 font-black text-slate-800 text-5xl tracking-tighter mb-8"><span>{hardFmt(val)}</span></div>
                    <div className="calc-grid">
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => <button key={n} onClick={() => press(n)} className="calc-btn active:bg-slate-200">{n}</button>)}
                        <button onClick={() => setVal('0')} className="calc-btn text-red-500 active:bg-red-50">C</button>
                        <button onClick={() => press(0)} className="calc-btn active:bg-slate-200">0</button>
                        <button onClick={back} className="calc-btn active:bg-slate-200"><i data-lucide="delete"></i></button>
                    </div>
                    <button onClick={() => onNext(val)} className="w-full mt-6 py-5 bg-green-600 text-white rounded-[24px] text-lg font-black uppercase tracking-widest border-none">Siguiente</button>
                </div>
            );
        });

        const App = () => {
            const dateInputRef = useRef(null);
            const [showOnboarding, setShowOnboarding] = useState(() => !localStorage.getItem('gdp_onboarding_813'));
            const [yearsData, setYearsData] = useState(() => {
                const saved = localStorage.getItem('gdp_v7_9_master');
                return saved ? JSON.parse(saved) : { "2026": [] };
            });
            const [currentYear, setCurrentYear] = useState("2026");
            const [view, setView] = useState('home'); 
            const [selectedPId, setSelectedPId] = useState(null);
            const [selectedSubId, setSelectedSubId] = useState(null);
            const [selectedMovId, setSelectedMovId] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalType, setModalType] = useState(''); 
            const [modalStep, setModalStep] = useState('importe');
            const [formGasto, setFormGasto] = useState({ importe: '0', catId: 'Misc', icon: 'more-horizontal', fecha: new Date().toISOString().split('T')[0], nota: '' });
            const [entryForm, setEntryForm] = useState({ n: '', val: '', icono: 'home' });
            const [exportStatus, setExportStatus] = useState(false);

            useEffect(() => { localStorage.setItem('gdp_v7_9_master', JSON.stringify(yearsData)); }, [yearsData]);
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });

            const handleExport = () => {
                const dataStr = JSON.stringify(yearsData, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Margen_Backup.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                setExportStatus(true);
                setTimeout(() => setExportStatus(false), 2000);
            };

            const resetForms = () => {
                setEntryForm({ n: '', val: '', icono: 'home' });
                setFormGasto({ importe: '0', catId: 'Misc', icon: 'more-horizontal', fecha: new Date().toISOString().split('T')[0], nota: '' });
            };

            const openModal = (type, step = 'importe') => {
                if (!type.includes('edit')) resetForms();
                setModalType(type);
                setModalStep(step);
                setIsModalOpen(true);
            };

            const handleSaveEntry = () => {
                const valNum = parseInt(entryForm.val) || 0;
                const catInfo = CATALOGO_PRESUPUESTOS.find(c => c.id === entryForm.icono) || CATALOGO_PRESUPUESTOS[0];
                let newList = [...(yearsData[currentYear] || [])];
                if (modalType === 'add_p') newList.push({ id: Date.now(), n: entryForm.n, i: entryForm.icono, c: catInfo.color, total: valNum, sub: [], directMovs: [] });
                else if (modalType === 'edit_p') newList = newList.map(p => p.id === selectedPId ? { ...p, n: entryForm.n, total: valNum, i: entryForm.icono, c: catInfo.color } : p);
                else if (modalType === 'add_s') newList = newList.map(p => p.id === selectedPId ? { ...p, sub: [...(p.sub || []), { id: Date.now(), n: entryForm.n, i: 'folder', lim: valNum, movs: [] }] } : p);
                else if (modalType === 'edit_s') newList = newList.map(p => p.id === selectedPId ? { ...p, sub: p.sub.map(s => s.id === selectedSubId ? { ...s, n: entryForm.n, lim: valNum } : s) } : p);
                setYearsData({ ...yearsData, [currentYear]: newList });
                setIsModalOpen(false);
            };

            const handleFinalizarGasto = () => {
                const mov = { id: selectedMovId || Date.now(), concepto: formGasto.nota || "Gasto", importe: formGasto.importe, fecha: formGasto.fecha, catId: formGasto.catId, icon: formGasto.icon };
                const newList = (yearsData[currentYear] || []).map(p => {
                    if (p.id !== selectedPId) return p;
                    if (selectedSubId) {
                        const newSub = p.sub.map(s => s.id === selectedSubId ? { ...s, movs: [mov, ...(s.movs || []).filter(m => m.id !== (selectedMovId || 0))] } : s);
                        return { ...p, sub: newSub };
                    }
                    return { ...p, directMovs: [mov, ...(p.directMovs || []).filter(m => m.id !== (selectedMovId || 0))] };
                });
                setYearsData({ ...yearsData, [currentYear]: newList });
                setIsModalOpen(false);
                setSelectedMovId(null);
            };

            const currentYearList = yearsData[currentYear] || [];
            const pAct = currentYearList.find(p => p.id === selectedPId) || null;
            const sAct = pAct?.sub?.find(s => s.id === selectedSubId) || null;
            const getGasS = (s) => (s.movs || []).reduce((acc, m) => acc + parseInt(m.importe.toString().replace(/\./g,'')), 0);
            const getGasP = (p) => (p.sub || []).reduce((acc, s) => acc + getGasS(s), 0) + (p.directMovs || []).reduce((acc, m) => acc + parseInt(m.importe.toString().replace(/\./g,'')), 0);

            return (
                <div className="app-shell">
                    {showOnboarding && (
                        <div className="welcome-screen">
                            <div>
                                <div className="visual-hero">
                                    <div className="hero-icon hi-1"><i data-lucide="plane" size={28}></i></div>
                                    <div className="hero-icon hi-2"><i data-lucide="shopping-bag" size={28}></i></div>
                                    <div className="hero-icon hi-3"><i data-lucide="smile" size={28}></i></div>
                                    <div className="hero-icon hi-4"><i data-lucide="baby" size={28}></i></div>
                                    <div className="hero-icon hi-5"><i data-lucide="heart-pulse" size={28}></i></div>
                                </div>
                                <h1 className="welcome-title">Tus planes<br/>bajo control</h1>
                                <p className="welcome-msg">Gestiona tus presupuestos de forma fácil. Controla cuánto te queda disponible y disfruta de tus planes.</p>
                            </div>
                            <button onClick={() => { localStorage.setItem('gdp_onboarding_813', 'true'); setShowOnboarding(false); }} className="btn-welcome">Crear mi primer presupuesto</button>
                        </div>
                    )}

                    {view === 'home' && (
                        <div key="view-home" className="view-transition">
                            <header className="header-home">
                                <div className="year-selector"><span>{currentYear}</span></div>
                                <button onClick={handleExport} className={`btn-export ${exportStatus ? 'success' : ''}`}>
                                    <i data-lucide={exportStatus ? "check" : "cloud-download"} size={20}></i>
                                </button>
                            </header>
                            <div className="main-content">
                                {currentYearList.map(p => (
                                    <div key={p.id} className="card-presupuesto shadow-sm">
                                        <div onClick={() => {setSelectedPId(p.id); setView('detalle');}} className="flex items-center gap-5 flex-grow cursor-pointer text-left"><div className={`icono-presupuesto ${p.c}`}><i data-lucide={p.i}></i></div><div><h3 className="texto-titulo">{p.n}</h3><div className="texto-info-secundaria"><span>{hardFmt(p.total)}</span><span className="opacity-30">|</span><span>Resta: {hardFmt(p.total - getGasP(p))}</span></div></div></div>
                                        <button onClick={() => { setSelectedPId(p.id); setEntryForm({ n: p.n, val: p.total.toString(), icono: p.i }); openModal('edit_p'); }} className="btn-edit-universal"><i data-lucide="pen-line"></i></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {view === 'detalle' && pAct && (
                        <div key="view-detalle" className="flex flex-col view-transition">
                            <header className="header-dark-strip"><div className="flex items-center gap-4"><button onClick={() => setView('home')} className="bg-white/10 p-2 rounded-xl border-none text-white"><i data-lucide="chevron-left"></i></button><h2 className="text-2xl font-black">{pAct.n}</h2></div></header>
                            <main className="px-6 pb-32">
                                <div className="bg-white p-8 rounded-[2.5rem] mb-6 text-left shadow-sm">
                                    <p className="text-[0.625rem] font-black uppercase text-slate-400 text-center mb-1">Disponible</p>
                                    <div className="flex justify-between items-baseline mb-2"><h3 className="text-4xl font-black">{hardFmt(pAct.total - getGasP(pAct))}</h3><span className="text-[0.6875rem] font-bold text-slate-400 uppercase">de {hardFmt(pAct.total)}</span></div>
                                    <div className="barra-progreso-bg"><div className={`${pAct.c} v-progress-liquid`} style={{ width: `${Math.min(100, (getGasP(pAct)/pAct.total)*100)}%` }}></div></div>
                                </div>
                                {pAct.sub && pAct.sub.map(s => (
                                    <div key={s.id} className="card-presupuesto text-left">
                                        <div onClick={() => {setSelectedSubId(s.id); setView('gastos');}} className="flex items-center gap-4 flex-grow cursor-pointer"><div className="w-12 h-12 rounded-2xl bg-slate-100 flex items-center justify-center text-slate-400"><i data-lucide="folder"></i></div><div><h4 className="text-xl font-extrabold text-slate-800">{s.n}</h4><div className="texto-info-secundaria text-xs"><span>Plan: {hardFmt(s.lim)}</span><span>•</span><span>Gasto: {hardFmt(getGasS(s))}</span></div></div></div>
                                        <button onClick={() => { setSelectedSubId(s.id); setEntryForm({ n: s.n, val: s.lim.toString() }); openModal('edit_s'); }} className="btn-edit-universal"><i data-lucide="pen-line"></i></button>
                                    </div>
                                ))}
                                {pAct.directMovs && pAct.directMovs.length > 0 && (
                                    <div className="mt-8">
                                        <p className="text-[0.625rem] font-black uppercase text-slate-400 mb-4 px-2 tracking-widest">Gastos Directos</p>
                                        {pAct.directMovs.map((m) => {
                                            const theme = BIBLIOTECA_GASTOS.find(b => b.cat === m.catId) || BIBLIOTECA_GASTOS[8];
                                            return (
                                                <div key={m.id} className="card-presupuesto p-5 mb-3 shadow-sm"><div className="flex items-center gap-4 flex-grow text-left"><div className={`w-11 h-11 rounded-2xl flex items-center justify-center text-white shadow-md ${theme.color}`}><i data-lucide={m.icon}></i></div><div><h4 className="font-bold">{m.concepto}</h4><p className="text-[0.625rem] font-black text-slate-400 uppercase">{m.catId}</p></div></div><div className="flex items-center gap-3"><span className="text-lg font-black">{hardFmt(m.importe)}</span><button onClick={() => { setSelectedSubId(null); setSelectedMovId(m.id); setFormGasto({importe: m.importe, catId:m.catId, icon:m.icon, fecha: m.fecha, nota: m.concepto}); openModal('add_g', 'importe'); }} className="btn-edit-universal"><i data-lucide="pen-line"></i></button></div></div>
                                            )
                                        })}
                                    </div>
                                )}
                            </main>
                        </div>
                    )}

                    {view === 'gastos' && sAct && (
                        <div key="view-gastos" className="flex-grow view-transition">
                            <header className="header-dark-strip"><div className="flex items-center gap-4 mb-6"><button onClick={() => setView('detalle')} className="bg-white/10 p-2 rounded-xl border-none text-white"><i data-lucide="chevron-left"></i></button><h2 className="text-xl font-black uppercase tracking-widest">{sAct.n}</h2></div><div className="flex justify-between bg-black/20 rounded-[2rem] p-5 text-center"><div><p className="opacity-60 text-[0.5rem] uppercase mb-1">Presupuesto</p><p className="font-black">{hardFmt(sAct.lim)}</p></div><div className="px-4 border-x border-white/10"><p className="opacity-60 text-[0.5rem] uppercase mb-1">Gastos</p><p className="font-black">{hardFmt(getGasS(sAct))}</p></div><div><p className="opacity-60 text-[0.5rem] uppercase mb-1">Saldo</p><p className="font-black text-green-400">{hardFmt(sAct.lim - getGasS(sAct))}</p></div></div></header>
                            <main className="px-6 pb-32">
                                {Object.entries((sAct.movs || []).reduce((acc, m) => { if(!acc[m.fecha]) acc[m.fecha] = []; acc[m.fecha].push(m); return acc;}, {})).map(([fecha, movs]) => (
                                    <section key={fecha} className="mb-8 text-left">
                                        <div className="flex justify-between border-b border-slate-200 pb-2 mb-4 text-[0.6875rem] font-black text-slate-400 uppercase"><span>{prettyDate(fecha)}</span><span>-{hardFmt(movs.reduce((sum,m)=>sum+parseInt(m.importe.toString().replace(/\./g,'')),0))}</span></div>
                                        {movs.map((m) => {
                                            const theme = BIBLIOTECA_GASTOS.find(b => b.cat === m.catId) || BIBLIOTECA_GASTOS[8];
                                            return (
                                                <div key={m.id} className="card-presupuesto p-5 mb-3 shadow-sm">
                                                    <div className="flex items-center gap-4 flex-grow text-left"><div className={`w-11 h-11 rounded-2xl flex items-center justify-center text-white shadow-md ${theme.color}`}><i data-lucide={m.icon}></i></div><div><h4 className="font-bold">{m.concepto}</h4><p className="text-[0.625rem] font-black text-slate-400 uppercase">{prettyDate(m.fecha)} • {m.catId}</p></div></div>
                                                    <div className="flex items-center gap-3"><span className="text-lg font-black">{hardFmt(m.importe)}</span><button onClick={() => { setSelectedSubId(sAct.id); setSelectedMovId(m.id); setFormGasto({importe: m.importe, catId:m.catId, icon:m.icon, fecha: m.fecha, nota: m.concepto}); openModal('add_g', 'importe'); }} className="btn-edit-universal"><i data-lucide="pen-line"></i></button></div>
                                                </div>
                                            )
                                        })}
                                    </section>
                                ))}
                            </main>
                        </div>
                    )}

                    <footer className="glass-footer">
                        <button onClick={() => { 
                            if(view === 'home') openModal('add_p'); 
                            else if(view === 'detalle') openModal('choice'); 
                            else openModal('add_g', 'importe'); 
                        }} className="circle-plus active:scale-90 transition-transform shadow-lg">+</button>
                        <span className="text-[0.625rem] font-black uppercase tracking-widest opacity-60 mt-1 tracking-widest">Añadir</span>
                    </footer>

                    {isModalOpen && (
                        <div className="fixed inset-0 z-[100] flex flex-col justify-end modal-overlay-bg bg-black/60 backdrop-blur-sm" onClick={(e) => e.target === e.currentTarget && setIsModalOpen(false)}>
                            <div className="relative w-full max-w-[448px] mx-auto bg-white rounded-t-[2.5rem] p-8 pb-12 shadow-2xl overflow-y-auto max-h-[90vh] modal-animate-content">
                                <button onClick={() => setIsModalOpen(false)} className="btn-close-modal"><i data-lucide="x"></i></button>
                                <div className="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8"></div>
                                
                                {modalType === 'choice' && (
                                    <div className="text-left"><h2 className="texto-titulo text-xl mb-6">Añadir</h2><button onClick={() => openModal('add_s')} className="w-full bg-slate-50 p-6 rounded-3xl text-left mb-4 border-none active:bg-slate-100 transition-colors"><h3 className="font-extrabold text-lg">Planificación</h3><p className="text-[0.625rem] font-black uppercase text-slate-400">Carpeta de grupos</p></button><button onClick={() => { setSelectedSubId(null); setSelectedMovId(null); setFormGasto({importe: '0', catId: 'Misc', icon: 'more-horizontal', fecha: new Date().toISOString().split('T')[0], nota: '' }); setModalType('add_g'); setModalStep('importe'); }} className="w-full bg-slate-50 p-6 rounded-3xl text-left border-none active:bg-slate-100 transition-colors"><h3 className="font-extrabold text-lg">Gasto directo</h3><p className="text-[0.625rem] font-black uppercase text-slate-400">Registrar movimiento</p></button></div>
                                )}

                                {(modalType.startsWith('add') || modalType.startsWith('edit')) && modalType !== 'add_g' && (
                                    <div className="text-left">
                                        <h2 className="texto-titulo text-xl mb-6">Configuración</h2>
                                        <div className="bg-slate-50 p-5 rounded-3xl mb-4"><p className="text-[0.5rem] font-black uppercase text-slate-400 mb-1 tracking-widest">Nombre</p><input value={entryForm.n} onChange={e=>setEntryForm(prev=>({...prev, n:e.target.value}))} type="text" className="bg-transparent w-full text-lg font-bold outline-none border-none" placeholder="Nombre..." /></div>
                                        <div className="bg-slate-50 p-5 rounded-3xl mb-6"><p className="text-[0.5rem] font-black uppercase text-slate-400 mb-1 tracking-widest">Importe</p><input value={entryForm.val} onChange={e=>setEntryForm(prev=>({...prev, val:e.target.value}))} type="number" className="bg-transparent w-full text-lg font-bold outline-none border-none" placeholder="0 €" /></div>
                                        {!modalType.includes('_s') && (
                                            <div className="grid grid-cols-4 gap-2 mb-8">
                                                {CATALOGO_PRESUPUESTOS.map(item => (
                                                    <div key={item.id} onClick={()=>setEntryForm(prev=>({...prev, icono:item.id}))} className={`p-4 rounded-2xl flex flex-col items-center gap-1 transition-all ${entryForm.icono === item.id ? 'bg-black text-white scale-105' : 'bg-slate-50 text-slate-400'}`}><i data-lucide={item.id}></i><span className="text-[0.5rem] uppercase font-black">{item.label}</span></div>
                                                ))}
                                            </div>
                                        )}
                                        <button onClick={handleSaveEntry} className="w-full py-5 bg-black text-white rounded-[24px] font-black text-xs uppercase border-none active:opacity-80">GUARDAR</button>
                                    </div>
                                )}

                                {modalType === 'add_g' && (
                                    <div>
                                        {modalStep === 'importe' && <Calculator initialValue={formGasto.importe} onNext={v => { setFormGasto(prev=>({...prev, importe: v})); setModalStep('categoria'); }} />}
                                        {modalStep === 'categoria' && (
                                            <div className="text-left px-2">
                                                {BIBLIOTECA_GASTOS.map(item => (
                                                    <div key={item.cat}>
                                                        <h3 className="gasto-header-title">{item.cat}</h3>
                                                        <hr className="mb-2 opacity-10" />
                                                        <div className="gasto-grid">
                                                            {item.icons.map(iconName => (
                                                                <button key={iconName} onClick={() => { setFormGasto(prev=>({...prev, catId: item.cat, icon: iconName})); setModalStep('fecha'); }} className={`gasto-icon-btn ${item.color} ${formGasto.icon === iconName && formGasto.catId === item.cat ? 'selected scale-110' : ''}`}><i data-lucide={iconName}></i></button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                        {modalStep === 'fecha' && (
                                            <div className="text-left"><h2 className="texto-titulo text-xl mb-6 text-center">Fecha</h2><div onClick={() => dateInputRef.current?.showPicker()} className="bg-blue-50 p-6 rounded-3xl border border-blue-100 text-center mb-4 cursor-pointer active:scale-95 transition-transform"><span className="text-xl font-bold text-blue-900">{prettyDate(formGasto.fecha)}</span><input ref={dateInputRef} type="date" value={formGasto.fecha} onChange={e => setFormGasto(prev=>({...prev, fecha: e.target.value}))} className="absolute opacity-0 pointer-events-none" /></div><button onClick={() => setModalStep('note')} className="w-full py-5 bg-black text-white rounded-[24px] font-black text-xs uppercase border-none tracking-widest active:bg-slate-800">SIGUIENTE</button></div>
                                        )}
                                        {modalStep === 'note' && (
                                            <div className="text-left"><h2 className="texto-titulo text-xl mb-6 text-center">Concepto</h2><textarea value={formGasto.nota} onChange={e => setFormGasto(prev=>({...prev, nota: e.target.value}))} className="w-full bg-slate-50 p-6 rounded-3xl h-32 outline-none border-none text-lg font-bold resize-none" placeholder="Nota rápida..."></textarea><button onClick={handleFinalizarGasto} className="w-full py-5 bg-green-600 text-white rounded-[24px] font-black text-xs uppercase mt-6 border-none tracking-widest active:bg-green-700">FINALIZAR</button></div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>